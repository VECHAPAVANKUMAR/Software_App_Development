<!DOCTYPE html>
<html lang="en">
 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">

    <title>Home</title>
    <style>
        
        .input-group-prepend {
            width: 100%;
            font-size: medium;
        }
 
        .searchform label {
            font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
            font-size: large;
            padding-top: 0;
            padding-left: 8px;
        }

        #pop {
            text-align: center;
        }

        input.star { display: none; }

        label.star {
            float: right;
            padding: 0 10px 0 10px;
            font-size: 36px;
            color: #444;
            transition: all .2s;
        }

        input.star:checked ~ label.star:before {
            content: '\f005';
            color: #FD4;
            transition: all .25s;
          }

          input.star-5:checked ~ label.star:before {
            color: #FE7;
            text-shadow: 0 0 20px #952;
          }

          input.star-1:checked ~ label.star:before { color: #F62; }

          label.star:hover { transform: rotate(-15deg) scale(1.3); }

          label.star:before {
            content: '\f006';
            font-family: FontAwesome;
          }

    </style>
 
    <script>

        const email = "{{email}}"
        
        function search() {
 
            const request = new XMLHttpRequest();

            const value = document.querySelector('#search_item').value.trim();

            if (value.length === 0) {

                document.querySelector('#load').style.color = "red";
                document.querySelector('#load').innerHTML = "<br><b>You can't leave search bar empty<b>"
                return;
            }

            document.querySelector('#load').style.color = "black";

            request.open("POST" , "/api/search")
            request.setRequestHeader("Content-Type", "application/json; charset=UTF-8");
 
            document.querySelector('#books').innerHTML = ""
            document.querySelector('#load').innerHTML = "<br><b>Loading Results<b>"
 
            request.onload = () => {
                
                const response = JSON.parse(request.responseText);
                
                if (request.status === 200) {
 
                    response.books.forEach(book => {
                    
                    document.querySelector('#load').innerHTML = ""
                    
                    let content = `
        
                            <div class="col-xs-12 col-sm-6 col-md-4 col-lg-4" style="margin-top: 4%;">
 
                                <div class="card" style="width: 18rem;">
                                        <img class="card-img-top" src="{{ url_for('static', filename='images/book.png') }}"
                                        alt="Card image cap">
                                    <div class="card-body">
                                        <h5 class="card-title">Title</h5>
                                        <p class="card-text"><b>${book.title}</b></p>
                                        <button type="submit" class="btn btn-primary" style="width: 150px;" onclick="book(${book.isbn})">Review</button>
                                    </div>
                                </div>
                            </div>
                            
                            `;
 
                    document.querySelector('#books').innerHTML += content
 
                }); 
 
                } else {
                    document.querySelector('#load').style.color = "red";
                    document.querySelector('#load').innerHTML = "<br><b>" + response.error + "</b>";
                }                 
            }
 
            const jsonData = JSON.stringify({"search" : value, "email" : email})
            request.send(jsonData);
            return false;
        }

        function book(isbn) {

            const request = new XMLHttpRequest();

            request.open("POST" , "/api/book")
            request.setRequestHeader("Content-Type", "application/json; charset=UTF-8");

            document.querySelector('#books').innerHTML = ""
            document.querySelector('#reviews').innerHTML = ""

            request.onload = () => {

                if (request.status === 200) {

                    const response = JSON.parse(request.responseText);
                    
                    let displaydata = `

                    <table class="table">
                        <thead class="thead-light">
                            <tr>
                                <th scope="col" class="bg-warning">Fields</th>
                                <th scope="col">Details</th>
                            </tr>

                            <tr>
                                <td class="bg-warning">ISBN No.</td>
                                <td class="table-light">"${response.book.isbn}"</td>
                                </tr>
                                <tr>
                                    <td class="bg-warning">Title</td>
                                    <td class="table-light">${response.book.title}</td>
                                </tr>
                                <tr>
                                    <td class="bg-warning">Author</td>
                                    <td class="table-light">${response.book.author}</td>
                                </tr>
                                <tr>
                                    <td class="bg-warning">Publishing Year</td>
                                    <td class="table-light">${response.book.year}</td>
                                </tr>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="width:100%">

                        <div>
                            <p><b>Please rate your book here:</b></p>
                        </div>

                        <div style="width:270px">
                            <input class="star star-5" id="star-5" type="radio" name="star" value=5 required />
                            <label class="star star-5" for="star-5"></label>
                            <input class="star star-4" id="star-4" type="radio" name="star" value=4 required />
                            <label class="star star-4" for="star-4"></label>
                            <input class="star star-3" id="star-3" type="radio" name="star" value=3 required />
                            <label class="star star-3" for="star-3"></label>
                            <input class="star star-2" id="star-2" type="radio" name="star" value=2 required />
                            <label class="star star-2" for="star-2"></label>
                            <input class="star star-1" id="star-1" type="radio" name="star" value=1 required />
                            <label class="star star-1" for="star-1"></label>
                        </div>

                        <div>
                            
                            <label for="validationTextarea" style="color: black;font-size:larger;">Comment</label>
                            <textarea class="form-control is-invalid" name= "textarea" id="comment" placeholder="Required example textarea" required> </textarea> <br>
                        
                            <button type="submit" class="btn btn-primary" style="width: 150px;" onclick = "submitReview(${isbn})">Submit</button><br>
                            <span id="error"></span>

                        </div>
                    </div>
                    `;

                    document.querySelector('#books').innerHTML += displaydata 
                    response.reviews.forEach(review => {
                        
                        let content =  `

                        <div style="width:100%">

                            <br>
                            <b> Email : </b> ${review.emailid} <br>
                            <b> Rating : </b> ${review.rating} <br>
                            <b> Review : </b> ${review.comments} <br>
                            
                        </div>
                        `;
                        document.querySelector('#reviews').innerHTML += content});
                } else {
                    document.querySelector('#load').style.color = "red";
                    document.querySelector('#load').innerHTML = "<br><b>" + response.error + "</b>";
                }
            }
            const jsonData = JSON.stringify({"isbn" : isbn.toString().padStart(10, "0"), "email" : email})
            request.send(jsonData);
            return false;
        }

        function submitReview(isbn) {

            const comment = document.querySelector('#comment').value.trim();

            if (comment.length === 0) {
                document.querySelector('#error').style.color = "red";
                document.querySelector('#error').innerHTML = "<br><b>review message cannot be empty<b>"
                return;
            }

            document.querySelector('#error').style.color = "black";
            document.querySelector('#error').innerHTML = ""

            let rating = 0;

            document.querySelectorAll('.star').forEach((radio) => {
                if (radio.checked) {
                    rating = radio.value;
                }
            });

            const request = new XMLHttpRequest();

            request.open("POST" , "/api/submit_review")
            request.setRequestHeader("Content-Type", "application/json; charset=UTF-8");

            request.onload = () => {

                const response = JSON.parse(request.responseText);

                console.log(response);

                if (request.status === 200) {
                    
                    document.querySelector('#reviews').style.color = "black";
                    document.querySelector('#reviews').innerHTML = `

                    <div style="width:100%">

                        <br>
                        <b> Email : </b> ${email} <br>
                        <b> Rating : </b> ${rating} <br>
                        <b> Review : </b> ${comment} <br>
                        
                    </div>

                    ` + document.querySelector('#reviews').innerHTML;

                } else {
                    document.querySelector('#error').style.color = "red";
                    document.querySelector('#error').innerHTML = "<br><b>" + response.error + "</b>";
                }

            }

            const jsonData = JSON.stringify({"email" : email, "isbn" : isbn.toString().padStart(10, "0"),
            "comment" : comment, "rating" : rating})

            request.send(jsonData);
            return false;

        }

    </script>
</head>
<header>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark sticky-top">
        <a class="navbar-brand" href="/index">Book Reviews</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="./">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout">Logout</a>
                </li>
            </ul>
        </div>
    </nav>
</header>
 
<body>
 
    {% with messages = get_flashed_messages() %} 
    {% if messages %}
        {% for msg in messages %}
 
            <div class="alert alert-warning alert-dismissible fade show" role="alert" id="pop">
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
              <strong>{{msg}}</strong> 
            </div>
            
            <script>
              $(".alert").alert();
            </script>
 
        {% endfor %}
    {% endif %}
    {% endwith %}
    
    <span id="email" value={{email}}></span>
    <div class="container">
 
        <div class="row" style="margin-top: 5%;">
            
            <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3"></div>
 
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
 
                <legend style="text-align: center;">Search Book</legend>
 
                <p>Search for your favourite book either by it's isbn or title or by author name or by it's published year</p>
 
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <input type="search" placeholder="" name="search_item" class="form-control" id="search_item"
                                aria-label="search_item" aria-describedby="basic-addon1" required>
                            <span class="input-group-text" id="basic-addon1"><i class="fa fa-search" aria-hidden="true"></i></span>
                        </div>
                    </div>
 
                    <div>
                        <button type="submit" class="btn btn-primary" style="width: 150px;" onclick="search()">Search</button>
                    </div>
                    <p id="load" style="text-align: center;"></p>
                </div>
            <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3"></div>
        </div>
 
        <div class="row" id="books">
        </div>
        <div class="row" id="reviews">
        </div>
    </div>
 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
</body>
 
</html>
